# Project TODO

## 數據庫設計
- [x] 設計價格記錄表 (priceRecords) 儲存每次檢查的價格數據
- [x] 設計監控日誌表 (monitorLogs) 記錄每次檢查的時間戳和結果
- [x] 設計通知記錄表 (notifications) 記錄所有發送的通知

## 後端功能
- [x] 實作網頁爬蟲邏輯,抓取阿拉斯加航空里程票頁面
- [x] 實作價格解析功能,提取所有日期的里程票價格
- [x] 實作75k特價票檢測邏輯
- [x] 整合email通知功能 (使用notifyOwner)
- [x] 建立tRPC procedures: 獲取最新價格、歷史記錄、手動觸發檢查
- [x] 實作定時任務邏輯 (每15分鐘執行一次)

## 前端功能
- [x] 設計優雅的視覺風格 (elegant and perfect style)
- [x] 建立監控狀態儀表板
- [x] 顯示當前最新價格數據 (日曆格式)
- [x] 顯示歷史價格變化圖表
- [x] 顯示監控日誌列表
- [x] 實作手動觸發檢查按鈕
- [x] 顯示75k特價票提醒

## 測試與部署
- [x] 撰寫 vitest 測試覆蓋核心功能
- [x] 測試定時任務運作
- [x] 測試email通知功能
- [x] 建立專案checkpoint


## 篩選器功能 (新寶)
- [x] 設計篩選器配置表 (filterSettings) 儲存用戶自訂的監控價格
- [x] 實作後端篩選器邏輯,支援多個目標價格
- [x] 建立tRPC procedures: 獲取/設定篩選器配置
- [x] 開發前端篩選器設定UI
- [x] 整合篩選器與監控邏輯
- [x] 撰寫篩選器功能測試


## 爆蟲修複 (緊急)
- [x] 診斷為什麼爆蟲無法抷取動态渲染的日曆價格
- [x] 安裝 Puppeteer 或 Playwright 用於動态頁面抷取
- [x] 重寫 fetchFlightPrices 使用改進的HTML解析策略
- [x] 測試修複後的爆蟲是否能正確抷取175k價格
- [x] 驗證系統能否正確識別所有價格

## Email收件人功能 (新寶)
- [x] 設計收件人表 (emailRecipients) 儲存用戶自訂的監控價格
- [x] 實作後端收件人管理(新寶、删除、驗證email)
- [x] 建立tRPC procedures: 獲取/新寶/删除收件人
- [x] 開發前端收件人管理UI
- [x] 更新通知邏輯以支援多個收件人
- [x] 撰寫 email收件人功能測試


## 特價票檢測邏輯改進 (新寶)
- [x] 修改notifications表以記錄每個篩選器找到的票數
- [x] 更新monitorService以按篩選器記錄結果
- [x] 修改queries.ts以返回按篩選器分類的統計數據
- [x] 更新Home.tsx顯示「發現篩選器的票」而非「發現特價票」
- [x] 新寶篩選器詳情卡片顯示每個篩選器的結果
- [x] 更新監控日誌顯示篩選器分類信息
- [x] 測試改進後的邏輯


## 篩選器檢測問題修複 (緊急)
- [x] 檢查篩選器是否正確儲存並啟用
- [x] 檢查價格數據是否正確抷取
- [x] 檢查監控邏輯的價格比對是否正確
- [x] 修改checkForDeals邏輯以立即觸發通知
- [x] 測試175k篩選器是否能正確檢測並通知


## Email發送功能 (緊急)
- [x] 安裝Nodemailer套件
- [x] 建立email發送服務模組
- [x] 設定SMTP配置(使用Gmail或其他服務)
- [x] 更新monitorService以實際發送email
- [x] 測試email發送功能


## 定時任務UI更新問題 (緊急)
- [x] 診斷數據庫 priceRecords插入錯誤
- [x] 修複數據庫錯誤
- [x] 實現前端自動輮詢機制(每15分鐘自動刷新數據)
- [x] 測試前端自動更新是否正常運作


## 定時任務穩定性修復 (緊急)
- [x] 檢查服務器日誌,診斷定時任務停止的原因
- [x] 添加錯誤處理和日誌記錄到scheduler
- [x] 實現定時任務的自動重試機制(3次重試)
- [x] 添加超時控制(10秒)
- [x] 測試定時任務在長時間運行中的穩定性


## 定時任務每15分鐘執行問題 (CRITICAL)
- [x] 診斷為什麼監控日誌顯示3小時6小時的間隔而不是15分鐘
- [x] 檢查scheduler.ts是否在服務器啟動時正確初始化
- [x] 驗證setInterval是否在後台持續運行
- [x] 修復爬蟲超時問題(從10秒增加到20秒)
- [x] 添加詳細的scheduler執行日誌記錄
- [x] 添加scheduler健康檢查API
- [x] 確保每15分鐘都有新的監控日誌記錄


## Scheduler 自動重啟機制 (新功能)
- [x] 實現 watchdog 機制定期檢查 scheduler 是否運行
- [x] 如果 scheduler 停止則自動重啟
- [x] 添加重啟日誌記錄
- [x] 測試異常情況下的自動恢複
- [x] 確保 scheduler 永不停止
